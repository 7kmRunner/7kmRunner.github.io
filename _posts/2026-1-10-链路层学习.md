---
layout: post
title: "网络层：数据平面学习"
date: 2026-1-11
tags: [编程]
comments: true
author: Minrain
---
## 链路层概况
链路层信道大致分两种，一种无线，一种有线。本章我们先学有线的网络。

基本的知识是：运行链路层协议的设备，我们叫做**节点**，连接它们的信道，称为**链路**。这一层的数据，称为**链路层帧**。

链路层协议提供的服务有以下几种：
1. 成帧。把网络层的数据包再包裹一层，称为帧。
2. 链路接入。通过MAC(Medium Access Control,介质访问控制)调控数据如何接入链路。
3. 可靠交付。类似应用层，通过检测和重传保证可靠交付。多用于无线信道，有线信道较可靠，没必要。
4. 差错检查和纠正。


## 6.1 链路层的存储
链路层以上：应用层、传输层、网络层都是软件，运行在操作系统上；物理层是纯硬件；而链路层一半软件，一半硬件。软件部分像是调度员，负责组装信息，下达指令；硬件部分也称网卡，负责脏活累活的操作(成帧，链路访问，差错检查)。

## 6.2 差错检验
第一个是奇偶校验。很好理解的方案，设置一个n维数组，1维或者2维，每个位置放0或1，每行或者每列求和得到一个数字，在对应某行某列的位置添加0或1使它成为偶数。接收方只需要数每行/每列中1的数量，再看后面的判断数，就知道哪里是不是有错误。

实践中链路层多用循环冗余检验，网络层多用校验和。循环冗余检验，就是mod2多项式环的多项式除法检验。具体表现：给一个二进制数->约定一个除数->补除数位数减1个0，大除法->得到余数->原数字补上余数传过去->接收方大除法看结果是否为0。

## 6.3 多路连接问题
问题是容易理解的。想象一群人坐在同一个会议室，多路连接就是研究谁在何时发言、发言时其他人能做什么，不能做什么，并尽可能让发言机会比较公平的学问。

信道划分协议分3类：时分复用、频分复用和码分多址。时分复用就是先把时间切分为单位的时间帧，每个时间帧再公平地分一小块时间给每个说话者。缺点是平均效率是R/N。频分复用，通过频率把一个信道平均分成N个，每个速率R/N。码分多址我们下一节学。

## 6.3.2 随机接入协议
随机接入协议旨在让节点拿到包裹就发送，再通过某些特殊处理，避免包裹冲突。

1. 时隙ALOHA协议。

按照帧的长度划分好时隙（时间单位），每个节点统一时间。在每个时隙开始前，如果手里有包裹，就发送。如果没有冲突万事大吉；如果有冲突，则产生冲突的节点开始抛硬币：一个几何分布，以p的概率抛到正面，接下来每个时隙，直到抛到正面，重新发送产生冲突的包裹。

这种协议利用率是1/e,大概37%。原始ALOHA协议，产生冲突则立即抛硬币。效率只有1/2e,大概18%。

2. CSMA协议

载波侦听多路访问，相对ALOHA,无论情况如何都要开口说话，出现不对再调整，CSMA的做法更文明一些。它采用监听的方法，如果听到有人说话，就先等到它们说完；没人说话时再自己说话。

这个协议的问题是，由于数据传输有时间，即便采用监听，也有可能信息互相干扰。比如A先听，发现没人说话，它就说话了；与此同时A的声音还没传到B的耳朵，B觉得也没人说话，于是也开始说话。这样就产生了冲突。

CSMA/CD是对原始协议的升级，它加入碰撞检测机制：每个人开始说话的时候也保持监听它人，一旦识别到有人说话，立即保持静默，并发送干扰信号提示其他人撞车。最后，经过一个随机的等待避让时间，再尝试发送。

3. 轮流协议。

轮流协议好像会议主持人模式。分为两类，第一，**轮询协议**：设置一个主节点当班主任，班主任挨个点名询问是否有人要发言。问题在于，班主任没了，系统就会瘫痪；点名要花时间，会引入轮询时延。第二，**令牌协议**。这种方式好像有个接力棒，持有接力棒的人才能发言；如果有话要说，就拿着接力棒直到话说完；否则直接把接力棒传给下一个人。

## 6.4 交换局域网
## 6.4.1 链路层地址和ARP
ARP(Address resolution Protocol)是地址解析协议，负责将IP地址转化为链路层地址。

主机和路由器没有链路层地址，而是他们的适配器（网络接口）有链路层地址。（IP地址绑定的也是网络接口）。链路层地址可称LAN地址，物理地址或MAC地址。MAC地址长度6字节，48位，使用十六进制表示，两个十六进制数一个字节。

IP地址像居住地信息，搬家可能就改变。MAC地址好像身份证，一出生就决定了，很难变化。

每个电子设备都有自己的适配器，适配器决定MAC地址。

ARP工作原理如下：第一步：拿到IP地址查内部缓存表，如果找到结束，找不到进入第二步。 第二步：广播，询问谁是IPXXX?所有人都会收到广播，然后对应设备回复。设备接收到讯息后存入缓存表，解析得到MAC地址。

如果IP地址在子网外，ARP会去找默认网关，提供的MAC地址是子网内部的默认网关MAC地址。

## 6.4.2 以太网
以太网的特征：提供无连接、不可靠的服务。以太网帧中包含校验码CRC、数据、类型（IPV4或IPV6）、前导码（对准时钟）、MAC地址。以太网数据的有效载荷最多1500，最少46，不够就会填充。网络层识别后丢弃填充部分。

原先总线运输使用CSMA/CD协议避免冲突，现在星形网络，直接就没有冲突了。

## 6.4.3 链路层交换机
交换机的功能：**转发**和**过滤**。假设帧从x接口接入，根据MAC地址检索表，处理：1.无记录，则进行泛洪转发，向除x外的所有接口发送。 2.查表发现就是x，就丢弃（过滤），说明已经正确到达目的地。 3.查表发现是y!=x，就向y转发

链路层交换机的关键特性是**自学习**，无需配置，即插即用。每台主机发送帧(动态更新)，它都会记录其源MAC地址(记录源地址)，如果表中没有就加入检索表。如果一段时间没有收到该主机发的信息，它就将其在表中移除。这也称之为老化期。

链路层交换机的优点有：链路异质（可以接多种的线路）、能避免碰撞(通过缓存)、易于管理。

## 6.4.4 路由器和交换机的异同
核心差异在于工作层次的不同。传统上路由器在第三层，交换机在第二层。（SDN中边界被模糊）。其它的差异在于：路由器转发速度比交换机慢；路由器拓扑结构任意，但交换机必须是生成树（不能有环路）；交换机更灵活，不需要手动配置IP地址；路由器能够进行流量隔离，并且运行算法优化转发路径，交换机不行。

另外，交换机负责的是局域网，路由器负责联系网络和网络。

## 6.4.5 VLAN
通俗来讲，VLAN网络就是利用一个物理实体（一个交换机），通过切分交换机的端口，把大块的局域网切成逻辑上的小块网络。

VLAN干线是为了解决两台交换机在不同VLAN端口上通信设立的。一根总线，通过给数据打上VLAN tag进行端口识别，运送到对应VLAN网络。

## 6.5 链路虚拟化
只讲一个重要协议，MPLS(MultiProtocol Label Switching,多协议标签交换)。

MPLS在第二层链路层和第三层网络层之间，通过给数据打固定长度的标签，解决传统路由查表慢、路径死板的问题。

具体来说，在MPLS网络中，每个路由器只需要读一下标签，就知道这个包裹应该送往哪，而不需要慢吞吞一个个地读最长前缀进行匹配。

## 6.7 小明上谷歌流程
假设说小明手里有一台手机，现在他要访问google.com，那么大致流程如下：

1. 小明需要先获得自己的IP地址。操作系统使用DHCP协议，通过UDP嵌入请求信息，以源IP地址0.0.0.0，目标IP地址255.255.255.255，手机MAC地址是源MAC地址，目标MAC地址是FF.FF.FF.FF.FF.FF发送以太网帧给交换机，请求IP地址。

2. 交换机是自学习的，它记录下小明的MAC地址，发现这个包是特殊的包，进行全局域网的广播，把消息发往路由器/DHCP服务器。

3. DHCP服务器接收请求报文，通过DHCP协议，广播一个IP地址，返回默认网关的IP地址、DNS服务器的IP地址以及子网掩码。

4. 小明手机获得了IP地址，他现在要查询google.com的DNS。假设返回的DNS服务器IP地址不在子网内部，那么这个包要经过默认网关路由发到DNS服务器。于是操作系统首先生成dns查询报文，此时发现目标MAC（默认网关路由）还没有，就通过ARP协议再生成MAC查询报文（IP地址是网关路由的），在局域网中广播。

5. 默认网关收到消息进行回复，小明获得默认网关MAC。

6. DNS查询报文发送到默认网关，默认网关对照目的IP（DNS服务器），转发报文到对应网络(ISP)。在该网络内，通过AS内部协议OSPF和跨AS协议BGP到达DNS服务器。DNS服务器回复。

7. 小明得到google的IP地址，可以上网了！

值得注意的是，小明的IP是私有网络内的IP。

