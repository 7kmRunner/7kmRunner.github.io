控制平面：大脑。负责规划路径，比如一辆车从A城开往B城，到达服务区，通过协议得到地图碎片后，它计算出接下来上哪条路。

数据平面：肌肉。负责执行命令。汽车开入服务区，控制平面告诉它接下来开往哪条路，它就把车开上那条路。

每台网络路由器中有一个**转发表**，类似导航，它告诉你，开到某一站后，接下来上哪条路。转发表正是由控制平面计算得到。

传统的实现中，路由由两个组件组成：1. 路由选择通信组件，用于选择接收路由通信信息，并计算出转发表。 2. 转发组件。负责把数据报转发到对应链路上。

**网络服务模型**定义了分组在发送与接收主机之间的端到端性质。网络服务可能有以下几类：
1. 确保交付。
2. 具有时延上界的确保交付。
3. 有序分组交付。
4. 安全性。
5. 最小带宽保证。

而因特网提供的服务是：**尽力而为的服务**，什么也不保证。然而从结果来看，已经足够好了。

路由器四个组件如下：
1. 输入端口。物理意义上的端口，处理链路层和物理层信息，并完成查找功能(通过查询转发表决定输出端口)。
2. 交换结构。路由器中的网络，负责把输入端口连接到输出端口。
3. 输出端口。在输出链路上传输分组（物理）。
4. 路由选择处理器。软件，维护路由选择表与关联链路信息，计算转发表。在SDN路由器中，负责与远程控制器通信。

类比的话，输入、输出端口类似交接货物的调度员，从物理层交接数据；交换结构是肌肉，路由选择处理器是大脑，路由选择处理器计算出结果，交换结构把对应货物搬运到对应出口。注意，这三个端口总是使用硬件实现。

基于直觉，转发方式可以有两种：基于目的地转发和泛化转发。比如，一辆汽车行驶到环状立交桥入口，调度员可以根据它的目的地安排它进入合适的匝道和出口，这就是基于目的地转发。同样的例子，调度员也可以根据该车的车牌（来源），车子的新旧程度作出不同的转发决策（太旧不让上车道），这就叫做泛化转发。

CIDR，无类别域间路由选择，是IP地址的分配策略。

RIP,距离矢量；OSPF(LS)，Dijk。ICMP通常被看作是IP的一部分，但体系上它应该在IP的上层，因为它往往在IP有效载荷的部分。ICMP是差错报告报文或者源抑制报文，用简单的编码表示信号。它相当于网络世界里报错的信差，哪里出了故障，就用它把消息告诉其它路由器。

实践中链路层多用循环冗余检验，网络层多用校验和。循环冗余检验，就是mod2多项式环的多项式除法检验。具体表现：给一个二进制数->约定一个除数->补除数位数减1个0，大除法->得到余数->原数字补上余数传过去->接收方大除法看结果是否为0。

时隙ALOHA协议。按照帧的长度划分好时隙（时间单位），每个节点统一时间。在每个时隙开始前，如果手里有包裹，就发送。如果没有冲突万事大吉；如果有冲突，则产生冲突的节点开始抛硬币：一个几何分布，以p的概率抛到正面，接下来每个时隙，直到抛到正面，重新发送产生冲突的包裹。这种协议利用率是1/e,大概37%。原始ALOHA协议，产生冲突则立即抛硬币。效率只有1/2e,大概18%。

轮流协议好像会议主持人模式。分为两类，第一，**轮询协议**：设置一个主节点当班主任，班主任挨个点名询问是否有人要发言。问题在于，班主任没了，系统就会瘫痪；点名要花时间，会引入轮询时延。第二，**令牌协议**。这种方式好像有个接力棒，持有接力棒的人才能发言；如果有话要说，就拿着接力棒直到话说完；否则直接把接力棒传给下一个人。

ARP(Address resolution Protocol)是地址解析协议，负责将IP地址转化为链路层地址。ARP工作原理如下：第一步：拿到IP地址查内部缓存表，如果找到结束，找不到进入第二步。 第二步：广播，询问谁是IPXXX?所有人都会收到广播，然后对应设备回复。设备接收到讯息后存入缓存表，解析得到MAC地址。

交换机的功能：**转发**和**过滤**。假设帧从x接口接入，根据MAC地址检索表，处理：1.无记录，则进行泛洪转发，向除x外的所有接口发送。 2.查表发现就是x，就丢弃（过滤），说明已经正确到达目的地。 3.查表发现是y!=x，就向y转发

假设说小明手里有一台手机，现在他要访问google.com，那么大致流程如下：
1. 小明需要先获得自己的IP地址。操作系统使用DHCP协议，通过UDP嵌入请求信息，以源IP地址0.0.0.0，目标IP地址255.255.255.255，手机MAC地址是源MAC地址，目标MAC地址是FF.FF.FF.FF.FF.FF发送以太网帧给交换机，请求IP地址。
2. 交换机是自学习的，它记录下小明的MAC地址，发现这个包是特殊的包，进行全局域网的广播，把消息发往路由器/DHCP服务器。
3. DHCP服务器接收请求报文，通过DHCP协议，广播一个IP地址，返回默认网关的IP地址、DNS服务器的IP地址以及子网掩码。
4. 小明手机获得了IP地址，他现在要查询google.com的DNS。假设返回的DNS服务器IP地址不在子网内部，那么这个包要经过默认网关路由发到DNS服务器。于是操作系统首先生成dns查询报文，此时发现目标MAC（默认网关路由）还没有，就通过ARP协议再生成MAC查询报文（IP地址是网关路由的），在局域网中广播。
5. 默认网关收到消息进行回复，小明获得默认网关MAC。
6. DNS查询报文发送到默认网关，默认网关对照目的IP（DNS服务器），转发报文到对应网络(ISP)。在该网络内，通过AS内部协议OSPF和跨AS协议BGP到达DNS服务器。DNS服务器回复。
7. 小明得到google的IP地址，可以上网了！

隐藏节点问题：A->B,C->B，由于A,C距离过远无法互相检测，但A,C都连接到B，就有可能A,C同时给B发消息，造成干扰。
暴露节点问题：A->B，C->D，C监听到B正在被A占用，不敢对D发，但实际上对D发不会造成实际影响。
CDMA(码分多址)技术：使用多国语言在一个房间内说话，互不干扰。具体而言，任何人想说话就说话（随时发送信号），但说的是不同语言（每个乘一个地址码），接收方会这种语言就能听懂，其它的都是噪音（解码用专用地址码，使对应信号重新聚集，其它的会被当作噪音丢弃。）

该体系的基本构成单位是BSS（基本服务集,Basic Service Set）,由一个接入点(AP,Access Point，可以当作基站)和若干无线终端组成。

802.11将通信频道分为若干信道，每个BSS分配一个（每个AP一个，信道可能相互干扰）。主机通过被动扫描或主动扫描，必须与一个AP关联。
被动扫描：主机接收AP发送的信标帧，选择一个AP进行连接请求。主动扫描：主机向AP发送请求帧，AP回应；主机选择一个AP连接，结束。

CSMA/CA（载波监听/冲突避免协议，CA,Collision Avoidance）。它是无线网络的交通规则。由于无线设备发送时声音太大，会盖过别人，所以没办法一边说一边检测；另外，由于隐藏节点问题，你很难检测到别人是否在说话。
它采用如下规则：先听再说->没人说话经过一段静默期(DIFS，分布式帧间间隔)，确保真的没人说话后发送->有人说话就随机生成一个数字。该数字当信道空闲时减少，为0就可以发送->发送后，在目的地通过一个SIFS（短帧间间隔）的时间，目的地回发确认报文->接收到确认报文，发下一个；否则再随机生成一个数字，重新发送。
## RTS和CTS解决碰撞问题
举手发言的解决方案，针对长信息发送。A、C都要发信息给B，A先广播：老师我要发言，需要X秒！B接收后广播(C也能听到)：A同学你说吧，给你X秒！C收到进入延迟，直到A说完后并收到B的ACK后。每次B收到消息后，都会有一个SIFS的反应时间。
CSMA/CD在发送过程中检测冲突，不使用确认机制
CSMA/CA在发送过程中不检测冲突，使用确认机制
这是两者最大的区别。

802.11帧对比以太帧，关键在于有3个地址，一个AP（基站）的，一个设备的（无线设备），一个路由的。AP在路由看来是隐形的，充当翻译官角色，在802.11帧和以太帧间翻译。地址三指的是传进来的路由地址。
在子网中的移动原理如下：假设AP1和AP2同属于一个交换机，移动设备检测AP信号强度，接入新AP时，新AP会在全网发送广播，告诉交换机该设备位置变化；交换机更新，问题解决。
但如果AP1和AP2不属于一个交换机呢？
下面引入概念：永久地址：手机联网的时候，永久属于它的IP地址，类似身份证号，不会轻易改变。
归属网络：永久地址属于的网络。
归属代理：归属网络的路由器。
外地网络：现在处于的网络。
外地代理：现在网络的代理。
转交地址：现在网络中的IP地址。
移动节点进入外地网络，首先在外地网络注册，然后外地网络告诉归属网络移动节点的位置。其它人给移动节点发信息，有两种方式。间接选路和直接选路。间接选路：先发给归属代理，归属代理转交移动节点；直接选路：问一下归属代理，直接发给移动节点。

传统加密方式有两种：替换和换位。非对称加密：每人一个公钥，一个私钥。最有名的是RSA算法，流程如下：选择两个大素数p,q(>10^100)，计算n=pq,计算z=(p-1)*(q-1),选择与z互质的数d，找到e使ed=1modz,则公钥为(e,n)，私钥为(d,n)
RSA加密与解密：将明文看作比特串，划分成块，大小为M。对每个M,计算M^e mod n = c,c即为密文 对每个密文，计算c^d mod n,结果即为明文。
RSA算法先用公钥和先用私钥的结果相同。

为了鉴别报文真实性，可以用报文鉴别码。需要一个鉴别密钥s，在AB之间共享，使用哈希函数，计算H(m+s)，得到的即为鉴别码。数字签名：先把报文内容映射到固定长的H(m)，然后利用自己的私钥解密得到的内容。Alice用他的公钥加密这堆东西，就得到明文。

目前最流行的两个电子邮件安全协议：PGP,S/MIME.PGP，对称密钥，公开密钥算法。IPSec,IP安全协议，用来搭建VPN。

防火墙：包过滤防火墙，很死板，按照固定规则，工作在网络层。状态监测防火墙，包过滤防火墙升级版，有状态表检测状态。应用网关，最高级，把每个包都拆开看，应用层。ESP（Encapsulating Security Payload，封装安全有效负载）隧道模式 (Tunnel Mode)
隧道模式是 IPsec VPN 的默认模式，常用于**网关到网关（Site-to-Site）**或主机到网关的连接。
封装结构： 整个原始IP数据包（包括原始IP头和数据）都会被 ESP 封装。然后，IPsec 会在最外面添加一个全新的外部 IP 头部，用于在公网中路由。传输模式，仅加密 IP 报文的有效载荷（Payload），即 TCP/UDP 头部及后续的数据。

