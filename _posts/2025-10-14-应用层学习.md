---
layout: post
title: "应用层学习"
date: 2025-10-14
tags: [编程]
comments: true
author: Minrain
---
### 2.1 网络应用原理
#### 2.1.1 网络应用体系结构
应用体系结构分为两类，客户-服务器体系结构和P2P体系结构。客户-服务器体系结构，就是说有一个中心化的特定场所，用于交换某类信息。比如大家都到菜市场买卖菜；P2P就是去中心化的，个人对个人的体系结构，比如A直接去找B，并向B购买需要的物品。
#### 2.1.2 进程的通信
事实上，进行通信的是进程而不是程序。程序好比写好的剧本，进程好比导演喊出“Action”后按剧本进行的演出，是活过来的程序。两个不同端系统上的进程，通过交换报文进行通信。

网络应用程序由成对的进程组成。其中发出请求的进程被称为客户端，负责回应的进程被称为服务器端。进程通过一个被称为套接字(socket)的接口接入网络，也称为应用编程接口。打个比方，套接字接口好比房子门口的邮箱，通过邮箱，人们发送或者接收信息。

发送信息需要接收端的地址，IP地址承担这个功能。由于一台主机上可能跑多个应用程序，我们还需要**端口号**来指定接收端的套接字接口（一台主机上可能有多个套接字接口，用于不同的程序，不同的进程）。
#### 2.1.3 可供应用程序使用的运输服务
套接字是应用程序进程和运输层协议之间的接口。对每个应用程序服务，我们应该针对它们的特点，选择不同的运输协议。我们大体能将应用程序的要求分为四类：
1. 可靠数据传输。不能丢失数据的应用场景，比如银行发账单给客户；与之相对的是可容忍数据丢失的场景，如视频、音频
2. 吞吐量。要求吞吐量大于等于一定值，比如两人语音通话，如果吞吐量太小，就很难交流。与之相对的是电子邮件、文字等，吞吐量弹性。
3. 定时。要求延时小于一定值。比如在线游戏，视频通话等。
4. 安全性。要防止信息被盗取的应用。
#### 2.1.4 因特网提供的运输服务
传输协议有两种，TCP和UDP。TCP提供可靠的数据传输服务和面向连接服务。面向连接服务指的是使用TCP接口的两个通信进程会先建立连接，然后可以双向传输数据。可靠的数据传输服务指的是传过去的数据不会有损失。TCP还拥有拥塞控制机制，该机制会在网络拥堵时限流，确保每个TCP协议尽量公平地使用带宽。

UDP提供不可靠的数据传输服务，且不建立连接。也就是说，它传过去的数据可能有漏，且可能是乱序。UDP不包括拥塞控制机制。
#### 2.1.5 应用层协议
应用层协议是网络应用的重要组成部分，它定义了运行在不同端系统上的进程如何相互传递报文，包括报文的类型，报文的语法，字段的含义和对话的规则。
### 2.2 Web和HTTP
#### 2.2.1 HTTP概述
HTTP是Web应用程序使用的应用层协议，超文本传输协议。一个Web网页也称文档，文档由对象组成，一个对象是一个文件。基本上每个网页都会有html基本文件，在这个文件中使用URL调用其它对象，如图片等。URL由两部分组成，提供服务的主机名，以及在主机中对象存放的路径。

Web浏览器实现了HTTP的客户端，Web服务器实现了HTTP的服务器端。HTTP则定义了客户端和服务器端交换信息的方式。HTTP是一个无状态协议，也就是说，服务器端不会保存客户端的信息。它没有记忆，忠实地处理每一个请求，而不管发出请求的是谁。HTTP协议选择TCP作为运输协议。
#### 2.2.2 非持续连接和持续连接
非持续连接，指的是客户端每次请求一个对象，就要建立一个TCP连接。操作如下：客户发出建立TCP连接的请求，服务器回应请求；客户向服务器发送确认请求。这些操作通过TCP协议进行，称为三次握手。之后客户请求http报文，每次请求一个对象；得到服务器返回的对象后关闭TCP连接。需要注意的是，请求报文和第三次握手几乎同时进行，不需要等待服务器再确认；如果第三次握手失败，服务器会重复第二次握手的过程，只有正确接收到第三次握手，服务器才会处理请求报文。

因此，非持续连接每请求一个对象的简化的时间消耗是2*RTT(Round Trip Time)+对象传输时间。

持续连接就是在建立连接后，请求/获取一个对象不断开连接，利用这个连接多次获取对象，省去连接建立的开销。
#### 2.2.3 HTTP报文格式
报文分两种，HTTP请求报文和HTTP响应报文。

请求报文由三部分组成，请求行，首部行，和实体体。请求行负责表明来意，你是要GET(获取对象)还是Post(填表单)？是要Head(测试)还是Delete(删除)？当然,Get也可以填表单。首部行相当于函数的参数，例如Host给出主机位置，connection为close还是open决定连接是否要断开，User_Agent给出浏览器类型。实体体负责写入用户希望提交的内容。

响应报文类似，分成状态行，首部行，实体体。状态行用来表明服务器查找的结果，构成为HTTP版本 状态码 状态，如HTTP1.1 200 OK。常见的状态码有200，表示正常；404，被请求的文档不在服务器上；400，服务器无法理解操作；505，服务器不支持HTTP版本。
#### 2.2.4 用户与服务器的交互：cookie
cookie是为了解决服务器“记不住”客户问题的技术。当用户访问某个网站时，如果是第一次访问，服务器在响应报文中会发送给用户一个Set_cookie首部行，用里面的数字标识用户。通过浏览器记录cookie后，用户以后的请求报文中都会自动带上cookie字样，于是服务器能够将访问的用户区别开，并根据每个用户的信息智能化提供不同的内容。
#### 2.2.5 Web缓存
Web缓存器，也叫代理服务器。原理好比把常用的调料放在手边，而不是冰箱里，降低跑路时间花费。也就是说，把源服务器的部分内容搬到一个临近端系统的代理服务器上，端系统先从代理服务器这里尝试获取所需内容，如果没有，由代理服务器向源服务器发出请求，备份并传递给源服务器。

关于数据不同步问题，比如源服务器中某个词条可能已被修改，但代理服务器中保存的还是原本的内容，使用条件GET方法解决问题。具体来说，
#### 2.2.6 HTTP/2
使用“错帧”的方法解决头阻塞问题，从而避免了开多个TCP通道的开销。具体来说，比如HTTP/1.1对某个网页的处理是开六个管道，HTTP/2只开一个，但把需要传的对象打上1-6的标记，每个分成小帧，轮流上传。
### 2.3 因特网中的电子邮件
电子邮件由三个重要部分组成：用户代理、邮件服务器和邮件通信协议。举个例子，Alice给Bob发邮件，在Alice写好邮件后，通过邮件代理，比如Gmail，发送到Alice的邮件服务器；该邮件服务器使用SMTP(Simple Mail Transfer Protocal)与Bob的邮件服务器通信，当Bob登陆后，通过代理从服务器处获取Alice的邮件。注意，SMTP协议只关注推，也就是发送过程，获取过程，或者拉，通常通过HTTP协议。
#### 2.3.1 SMTP
#### 2.3.2 邮件报文格式
#### 2.3.3 邮件访问协议
### 2.4 DNS：因特网的目录服务
一言以蔽之，DNS是一本大词典，负责把人们使用的主站地址（主站名字，例如www.bilibili.com）翻译成计算机里，更层次化的地址（IP地址）。IP地址由四个字节组成，每个字节用.隔开，每个字节代表一个数字，如121.7.106.83。
#### 2.4.1 DNS提供的服务
通常的DNS（Domain Name System,域名系统）指的是两个东西，一个是由分层的DNS服务器实现的分布式数据库，一个是一个帮助主机查询该数据库的应用协议。DNS协议运行在UDP上。
#### 2.4.2 DNS工作机理概述
查DNS就是查大字典，比如查询www.google.com对应的IP地址，我先去根服务器查找大章节（这里是.com），然后我在TLS（Top_Level Domain，顶级域）服务器里查找小章节（google），于是我到达google的权威服务器（词条）。这个权威服务器就告诉我这个主站地址对应的IP地址，我接着就可以访问了。

实际运行时，会通过本地DNS服务器以及缓存机制降低各类开销。本地DNS服务器类似于图书馆员，帮你查找某本书的某个内容；你直接找本地DNS问出某个主站的IP地址，这叫递归查询；本地DNS一层层问上去，直到问出最终结果，这叫迭代查询。图书馆员问到结果后，把结果记下来，下次你再来问直接给你看，它就不用再一层层往上问了，这就是缓存。
#### 2.4.3 DNS记录和报文
这里只提一下资源记录（Resource Record，RR）。资源记录是一个四元组，包含{Name,Value,Type,TTL(到期时间)}，存储在DNS服务器上。资源记录用于报文中进行查询和回复。
### 2.5 P2P文件分发
传统的客户-服务器架构，只由服务器上传文件，客户端消耗；P2P架构由于大家的地位相等，每人既消耗文件又上传文件，因此具有**参与的人越多，下载越快**和**不论多少台主机请求下载文件，总能在一个限定时间内完成**的特点。至于具体的协议，比如Bittorrent，可以用到的时候详细学习。
### 2.6 视频流和内容分发网
主要讲Youtube和Netflix的基本原理。
#### 2.6.1 因特网视频
视频由多张图像组成，每张图像称为帧。这些图像按一定的速度播放，就变成视频。每张图像由像素点组成，每个像素点由数字标识颜色亮度等属性。像素点越多，图像越清晰，占的空间就越大。
#### 2.6.2 HTTP流和DASH
HTTP流就是把视频当做一个对象，只能选择某个画质，然后服务器传给客户。

DASH(Dynamic Adaptive Streaming over HTTP，HTTP的动态适应性流)，通过将视频编码为几个不同清晰度的版本，使得客户可以按照自己的网速动态选择视频清晰度，每次服务器上载一块视频，清晰度变化后上载另一块，不是一次传完。
#### 2.6.3 内容分发网
CDN(Content Distribution Network,内容分发网)，目的是解决向全世界各地用户高质量传输视频的问题。通过深入（深入ISP装服务器）和邀请做客（在几个关键地区建大型服务器）两种方式安置服务器。类比来说，深入就是家门口的小卖铺，方便但体量较小；邀请做客就是城中心的大商场，规模大，商品全，但要跑路。

CDN部署，核心是集群选择策略。目标是最大化方便用户，带给用户最丝滑的体验。
#### 2.6.4 Netflix和YouTube
两个的区别在于，Netflix使用推高速缓存机制，在流量低峰期主动把新视频推送到CDN中；而Youtube是拉高速缓存机制，每次用户请求，它先检测有没有，如果没有再向源服务器要。
### 2.7 套接字编程：生成网络应用
应用程序有两种，开放的和专用的。开放的用大家所熟知的协议和端口号，专用的自己独立设计客户与服务器的交互方式。开放的大家可以根据协议独立设计出能与其交互的客户/服务端；专用的就不行。
#### 2.7.1 UDP套接字编程
#### 2.7.2 TCP套接字编程
关于这两种编程方式，我建议通过实践/动手的方式掌握，实在没什么可以记录的。
### 2.8 总结
这章主要讲的是应用层。一个应用程序，它在做什么，它是怎么做到的？这就用到协议，我们大致讲述了HTTP协议和Web应用程序的架构，然后讲了电子邮件，SMPT协议；然后是DNS、流视频的工作原理。学完这章，我们应大致对计算机网络的应用层原理有一个清晰的认知，比如，你知道了，你上b站看视频，中间的过程有什么。