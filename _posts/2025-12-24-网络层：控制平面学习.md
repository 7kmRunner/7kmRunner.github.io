---
layout: post
title: "网络层：数据平面学习"
date: 2025-11-20
tags: [编程]
comments: true
author: Minrain
---
## 5.2 路由选择算法
一般而言，路由选择算法可分为集中式路由选择算法(也称为链路状态算法或LS算法)和分布式路由选择算法。两者的区别就像在线算法和非在线算法。集中式路由选择算法知晓全局信息，分布式路由选择算法只知道局部信息，通过不断迭代逼近最优解。

还有的分类方法将它分为静态路由选择算法和动态路由选择算法。以及负载敏感算法和负载钝感算法。静态动态看的是边的权重变化速率，几乎不变，人为干预变化的是静态；随时变化的动态。负载是否敏感很容易理解，负载敏感就是权的变化对算法影响很大，钝感就是影响很小。

### 5.2.1 链路状态路由选择算法
链路状态路由选择算法即LS算法，是集中式算法，每个路由共享全局信息，使用迪杰斯特拉算法求出到每个节点的最小值。

LS算法运行过程如下：
第一步：泛洪。每个路由器发送自己知道的所有信息给其它路由器，大家把信息拼在一起，得到一个完整的图。
第二步：计算。使用算法计算出最优解。

LS算法在链路敏感的情况下会遇到震荡的问题，具体表现是：A空闲，大家发信息集体涌入A，致使A卡顿；大家再次发消息，又都来到B，B卡顿；如此震荡，网速一直卡。解决方法是异步处理，大家不一起发消息。

### 5.2.2 距离向量路由选择算法
距离向量路由选择算法维护一个n*n的矩阵，每一行，每一列代表n个路由中的一个，a[i][j]表示第i个路由到第j个路由的最短距离。初始大家只知道自己的情况，在邻居之间互相通告后，每个路由利用Ford算法进行更新，看能不能优化最短距离。能优化继续通告，如此往复，直到收敛。

关于“坏消息传得慢”，是因为如果发生断路或其它问题，信息会卡住不流通。比如A,B。A想到C必须经过B，此时B,C连接断了。B要通告这个消息。由于信息同步是异步的，没准A先通告B，它到C的距离是2(实际需要经过B)。此时B误以为A有自己的路，就把到C变成3（经过A）。信息就这样在A,B间打转，直到超过阈值才会停止。这也被称为环路问题。

关于“好消息传得快”。一有好消息，大家立刻就会知道，纷纷更新自己的最短路径。

“毒性逆转”：善意的谎言。为了解决上述环路问题，如果A依赖B到C，那么A要学会“欺骗”B，它只对B说自己到C的距离是+∞，对其他人正常通报。这样，B就不会指望A来到达C，它只能靠自己。于是解决了环路问题。不过需要注意的是，它只能解决两人之间的问题，不能解决“大环路”，比如三个路由器组成环的问题。

### 5.3 因特网中自治系统内部的路由选择：OSPF
路由选择算法当然是好的。问题在于，网络规模如果过大怎么办？方法是把整个系统切成一块块，使每个区域自治，再让多个区域联合成一大块。这也就是自治系统，AS(Autonomous System)。通常一个ISP是一个AS,享有一个AS号，不过也有一个ISP再划分成多个AS的情况。

每个AS内部使用相同的协议，OSPF就是其中很重要的一个，可以简单理解为LS算法。

它的特点有以下几点：
1. 安全。它使用了鉴权机制，保证不会被恶意攻击。
2. 可选多条相同开销的路径。
3. 支持单播和多播。
4. 支持单个AS中的结构层次。

### 5.4 ISP间的路由选择，BGP
OSPF是AS内部的路由选择协议，BGP是AS间的路由选择协议。BGP，即Broder Gateway Protocol,边界网关选择协议。

BGP算法匹配的是前缀而不是具体的IP地址。它依据最长前缀匹配原则，确认通往目的地的最好路由。如果说OSPF是城市内部送货的规划算法，BGP就是城市与城市之间送货的调度员（这里的城市是每个AS）。BGP是距离向量协议。

BGP为每台路由器提供了以下功能：
1. 从邻居AS获取前缀的可达信息，以及允许每个子网向因特网通知它的存在。
2. 确定到该前缀的最好路由。

BGP同样是先让各个AS通告，哪里有前缀，应该走哪条路。然后路由器计算出一个表，送包裹的时候根据最长前缀匹配原则，匹配上表项，运送到表项对应的结果处。

## 5.4.2 通告BGP路由信息
每个AS中，路由器分两类，**网关路由器**和**内部路由器**。

相同AS内的路由器连接，被称为**内BGP连接(iBGP)**;不同AS内的路由器连接，则称之为**外BGP连接(eBGP)**。

BGP是运行在部分路由器上的软件，BGP信息首先有一个前缀，然后子项里有AS_PATH和NEXT_HOP，一个记录到x的路径，一个记录下一跳路由的IP地址。

## 5.4.3 确定最好的路由
1. 热土豆路由选择
认为报文是一个糟糕的热土豆，要尽快传给另一个人(AS)，于是选择最小的内部的开销，锁定到开销最小的内部网关进行交接。(网关可以有多个)

局部最优，举例就是A,B,C在一个AS中，A需要到B，或者到C，哪个更近选哪个，不考虑后续运输的开销。
2. 路由器选择算法
对每个长度的相同前缀，BGP算法筛选出最优的一个填入表项：
第一轮：管理员根据个人偏好给每个可行的路由赋有权值，选取权值最高的。
第二轮：权值一样看谁的AS_PATH路径更短。
第三轮：路径长度一样看谁的内部开销最小（热土豆路由选择）
第四轮：如果还没分出胜负，选择id最小的（几乎随机）。

## 5.4.4 IP任播
假设你想找到某个内容，可以在AS1里找，也可以在AS2里找。那么AS1和AS2可以宣称它们拥有相同的前缀并进行通告。这给BGP选择提供更多可能，也方便信息传输。

综上，BGP主要有两个功能，一个是全局公告，告诉大家什么前缀在什么位置；一个是位置导航，帮助大家寻找前往目的地最优路线。

## 5.5 SDN
传统的网络有点民主的意思，大家互相通告，互相计算，彼此比较平等；SDN类似集权，只有一个大脑（可能有多个服务器），分三层架构：南向API：从下属获取信息；记忆层：存储下属们发过来的信息；北向API：直接与应用交互，传递命令。

## 5.6 ICMP
ICMP通常被看作是IP的一部分，但体系上它应该在IP的上层，因为它往往在IP有效载荷的部分。ICMP是差错报告报文或者源抑制报文，用简单的编码表示信号。它相当于网络世界里报错的信差，哪里出了故障，就用它把消息告诉其它路由器。