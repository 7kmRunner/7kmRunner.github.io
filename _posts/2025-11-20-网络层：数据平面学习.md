---
layout: post
title: "网络层：数据平面学习"
date: 2025-11-20
tags: [编程]
comments: true
author: Minrain
---
关于网络层，我们分成两部分来学习，数据平面和控制平面。

控制平面：大脑。负责规划路径，比如一辆车从A城开往B城，到达服务区，通过协议得到地图碎片后，它计算出接下来上哪条路。

数据平面：肌肉。负责执行命令。汽车开入服务区，控制平面告诉它接下来开往哪条路，它就把车开上那条路。

每台网络路由器中有一个**转发表**，类似导航，它告诉你，开到某一站后，接下来上哪条路。转发表正是由控制平面计算得到。

传统的实现中，路由由两个组件组成：1. 路由选择通信组件，用于选择接收路由通信信息，并计算出转发表。 2. 转发组件。负责把数据报转发到对应链路上。

而现在还存在一种名为SDN(软件定义网络，Software_Define_Networking)的方法。通过设立一个总管理员(远程服务器)统筹调度路线，使路由器仅承担运输工作，不必进行计算。
### 4.1.2 网络服务模型
**网络服务模型**定义了分组在发送与接收主机之间的端到端性质。网络服务可能有以下几类：
1. 确保交付。
2. 具有时延上界的确保交付。
3. 有序分组交付。
4. 安全性。
5. 最小带宽保证。

而因特网提供的服务是：**尽力而为的服务**，什么也不保证。然而从结果来看，已经足够好了。

这里详细叙述分组交换机的定义。所谓分组交换机，是指根据分组的首部，将分组从输入链路转移到输出链路。链路层交换机通过链路层帧的信息做决定，是链路层设备；其它的分组交换机统称路由，基于网络层数据报首部字段值做决定，是网络层设备。

### 4.2 路由器工作原理
路由器四个组件如下：
1. 输入端口。物理意义上的端口，处理链路层和物理层信息，并完成查找功能(通过查询转发表决定输出端口)。
2. 交换结构。路由器中的网络，负责把输入端口连接到输出端口。
3. 输出端口。在输出链路上传输分组（物理）。
4. 路由选择处理器。软件，维护路由选择表与关联链路信息，计算转发表。在SDN路由器中，负责与远程控制器通信。

类比的话，输入、输出端口类似交接货物的调度员，从物理层交接数据；交换结构是肌肉，路由选择处理器是大脑，路由选择处理器计算出结果，交换结构把对应货物搬运到对应出口。注意，这三个端口总是使用硬件实现。

基于直觉，转发方式可以有两种：基于目的地转发和泛化转发。比如，一辆汽车行驶到环状立交桥入口，调度员可以根据它的目的地安排它进入合适的匝道和出口，这就是基于目的地转发。同样的例子，调度员也可以根据该车的车牌（来源），车子的新旧程度作出不同的转发决策（太旧不让上车道），这就叫做泛化转发。

### 4.2.1 输入端口处理和基于目的地转发
值得一提的是，转发决策由每个输入端口本地作出，无需调用集中式选择处理器，因此避免了集中式方法的瓶颈；接下来我们来考虑转发表的实现。

如果对于每个给定的IP地址，都在转发表中占据一个位置，那么32bit的IP地址，将要求40亿的空间，这完全不现实。因此我们进行离散化处理，对每个IP，将它归类到某个范围，这个范围再对应到某个端口。匹配规则选择最长前缀匹配规则，也就是说，转发表中某些前缀可能直到最后几位，都一直相同，我们一直匹配到最长的那个前缀对应的端口再停止。比如111111，匹配111和11111，那么它会匹配到11111对应的端口。

### 4.2.2 关于交换的知识
交换的原理与发展史大致是这样的：
1. 总线交换。举个例子，20个输入端口，20个输出端口，中间一条总线。好比屋子里20个人，中间一个麦克风(总线)，谁对着麦克风说话(发送帧)，屋外的人都会接收到信息(20个输出端口)。需要的人保留信息，不需要的人丢弃信息(不需要的端口扔掉该帧)。完全不支持并行，有很大浪费的架构。

2. 内存交换。20个输入端口，20个输出端口，中间一个高速读写的内存。来了k个数据，先全部copy到内存里，然后再根据首部信息复制到对应输出端口。有限并行，不会造成空间浪费，比总线交换强不少。值得一提的是，假设内存读写速度为B，那么内存交换的吞吐量小于B/2。也很好理解，一个数据需要读/写各一次，占两次自己大小的资源。

3. 互联网络交换。总线交换好比单行车道，一个个被发送过去；内存交换好比起始点从多条路径经过同一个中转点，在该中转点发向不同的方向；互联网络交换就类似现代交通网络，多个起点多条路径避免冲突。譬如输入端口为A,B，输出端口为C,D，那么A有两条互相独立的路径分别连接C,D，运送时在路径中切换，B也是同理。这就大大提高了效率。互联网络交换支持并发。

### 4.2.3 排队分析及总结
主要是四种排队方式：
1. 先进先出。字面意思，谁先来的就先传输谁。
2. 优先权排队。VIP优先，很容易理解。给排队元素赋一个权值，相同条件下先传输高优先级的。
3. 循环排队。让排队的分组报数，报数相同的分组归为一类。每类提供一定的服务时间后，服务下一类。
4. 循环加权排队。循环排队的底子，但每类服务时间不一样，有权重。

## 4.3 IPv4，寻址，IPv6及其它
先来介绍IPv4数据报的结构，首先是**首部长度**，用来确定IP数据报中载荷实际开始的地方；然后是**服务类型**，**数据报长度**，字面意思；然后是标识、标志、片偏移，代表的是一个大IP数据报被切成多份后小数据报携带的标识信息；**TTL(Time-to-Live),寿命**是个重点，生命周期，经过一个路由器-1，为0则路由器必须丢弃该分组。然后是协议、首部校验和、源和目的IP地址、选项，都很容易理解。最后是数据，也称有效载荷。

一个IP数据报首部长度为20字节，一个TCP数据报首部长度同样为20字节。

### 4.3.1 IPv4编址
重要概念，主机与物理链路之间的边界叫做**接口**，路由器与它的任意一条链路间的边界也叫做**接口**。从技术上讲，每个IP地址应该与接口关联，而不是路由器或主机。

每个地址由32bit，4个字节组成，共约40亿种可能。记法是二进制的十进制表示，每个字节对应的位置是它表示的十进制数，中间用.隔开。

接下来我们引入子网的概念。所谓子网，是这样产生的：多根线接到一个路由器的接口上，这多根线就构成一个子网；也就是说，接到同一个路由器同一个接口的所有网线连接的设备构成的网络，叫做子网。注意不能漏掉两个路由器相互之间连接构成的子网，路由器A和B连接，A和B的两个接口对应的两个IP地址属于同一个子网。

对每个子网，需要一个子网掩码。形式如下：211.3.1.0/24(举例，每位的数字不一定长这样)。一共4个字节32位，/24说明这个子网下的IP前24位与子网掩码相同。

因特网的地址分配策略被称为**无类别域间路由选择(Classless Interdomain Router,CIDR)**。一个组织通常被分配一块连续的地址，它们具有相同的前缀。所谓前缀，指的是形如a.b.c.d/x地址的x最高比特。比如123.2.2.2/8，那么前缀就是123。x可以不是8的倍数，它看的是二进制位。比如例子中把8改成5，那么前缀就是二进制表示下的前5位。

以前的编址方案严格x是8的倍数，称为分类编址，8、16、24位比特子网分别被称为A、B、C类网络，但因为不够灵活，被弃用了。现在的编址方案，比如一个组织拿到前20位，组织内部还可以灵活的划分更小的网络。比如前23位对应一个子网的子网，其中前20位与该组织拿到的20位相同。

有一种IP地址是特殊的。255.255.255.255。当一台主机发送一份目的地址是255.255.255.255的数据报时，它将被交付给同一网络中的所有主机。

### 1.地址的分配
了解了编址规则，我们来看地址是怎么分配和获取的。首先，有一个全球统一的权威机构，ICANN，管理IP地址并向各ISP提供IP地址块，各ISP再向手下需求的组织进行分配。具体例子如上，一个ISP拿到前20位的地址块，他可以划分成8个等大小的前23位地址块，分配给手下8个组织。

### 2.地址的获取
地址的获取依靠的是**动态主机配置协议(Dynamic Host Configuration Protocol,DHCP)**。一般来说，网络的管理员可以对主机进行IP地址的手动分配，但管理员通常只手动分配路由的IP地址，其它设备的交给DHCP。DHCP允许主机自动获取一个IP地址，网络管理员可以控制对于某个主机，这个IP地址是固定的还是临时的。DHCP也允许主机获取一些信息，例如它的子网掩码，它的第一跳路由器地址，本地DNS服务器地址。

DHCP被称为即插即用协议或零配置协议。拿一个携带手机的学生举例子，他在宿舍联网，则他的手机会被动态分配一个IP地址；等他到图书馆，他的手机可能又会被新分配一个IP地址。不需要管理员操作，非常方便；IP地址谁用给谁，非常高效。共享经济这块。

DHCP是一个客户-服务器类协议。每个用户需要一个中继器或者直接连接到DHCP服务器来获取IP地址，具体流程如下：
1. DHCP发现。用户需要通过广播的方式寻找DHCP服务器来为它进行服务。具体过程是发一个原地址0.0.0.0，目标地址255.255.255.255的内容为寻找DHCP到IP报文广播到子网内，从而获取DHCP服务。
2. DHCP回应。DHCP收到报文，对客户进行回应，给出它能提供给客户的IP地址、IP地址租用期和子网掩码。
3. 客户选择。客户选择一个自己喜欢的DHCP提供的服务(可能收到多份回应报文)，享受DHCP的服务。
4. DHCP ACK。DHCP同意客户的请求并返回确认报文。

### 4.3.3 网络地址转换
上述规则很易懂，但实操起来可能遇到各式各样的困难。比如，如果你家庭里有超过256台设备怎么办呢？如果原本只分配给你255个IP地址，你这样设备一多难道要整体迁移吗？如果全球有超过50亿台主机怎么办？IP地址不是完全不够用吗？

解决这个问题靠的是NAT使能路由器，进行**地址转换**。具体原理大概是：NAT使能路由器掌握唯一的公网IP地址，内部的所有家庭设备，不管有多少，使用私用的全球免费开放的IP地址，接入到这个路由器。这样一个公网IP，就对应成百上千台家庭设备。外来讯息输入则NAT使能路由器查表把信息交给内部对应设备；设备信息输出则在路由器处先进行地址转换再发往目标地址。这样，一个内部IP可以反复用，解决了前述的问题。

或者打个比方。你们村有100号人，可只有1个人会写信和阅读。那么村外的人，只需要知道这个读书人的名字和住处就行了(IP)，东西写好交给他，他交给村内的人；村内的人向外发讯息同理，只找这个读书人写东西，由读书人发出。这样，外界只储存1个人的收件信息，就能联系100号人。

### 4.3.4 IPv6
相较于IPv4，IPv6删除了分片/重新组装、首部校验和、选项字段，更加简洁高效。由于IPv6主要目的是为了解决IP地址不够用的问题，现在它的地址高达128位，不可能用完了。

IPv6的字段包含：版本、流量类型、流标签、有效载荷长度、下一个首部(标识交给等协议，如TCP、UDP等)、跳限制、原地址和目标地址、数据。

关于IPv4标识(标记是否属于一个包裹)、标志(1说明不是最后一片，0是最后一片)、片偏移(前面总数据字节数/8)，有一句口诀：偏移乘8是位移，MF见0是结尾，计算偏移记得减去首部的20字节。

### IPv4到IPv6的迁移
这里引入**隧道**的概念，两台IPv6的路由，中间是IPv4的路由，就把这些IPv4路由整体看作一个隧道，IPv6的路由把IPv6的报文整个塞到一个IPv4的报文中，经过IPv4到另一个IPv6路由后，通过识别数据报的类型，断定这里面内容是原始的IPv6报文，就打开获取。这样就完成了兼容。

### 4.4 泛化转发
前面我们讲到基于目的地转发，现在我们讲泛化转发。泛化转发是“匹配加操作”概念的推广，它匹配更多的表项，拥有更多的操作。譬如：负载均衡转发、防火墙功能、修改首部。

实现泛化转发依赖分组交换机中的匹配和操作表，表的更新依靠远程控制，类似前文的SDN架构，因此分组交换机也称为SDN交换机。在本书中，传统路由器只能基于目的地转发，而分组交换机是泛化转发。

匹配加操作转发表在openflow里称为流表。组成包括：首部集合、计数器集合、对应的操作。

交换机是二层设备，路由是三层设备，而只有**分组交换机**横跨二层三层，使用泛化转发。

### 4.4.2 操作
流表项的操作可能有：转发、丢弃、修改字段。

### 4.4.5 中间盒
中间盒，指的就是不符合原本网络设计规范的网络中间的功能盒，比如前文中的NAT使能路由器，比如能泛化转发提供防火墙功能的分组交换机等等。